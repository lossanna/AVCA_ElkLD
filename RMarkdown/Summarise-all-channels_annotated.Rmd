---
title: "Summarise all channels annotated"
author: "Lia Ossanna"
date: "2023-03-24"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
load("../RData/Summarise-all-channels.RData")
```

# Introduction
- The data wrangling scripts produced tidy data, but had many 0 values based on how the data sheets were originally structured, and all the measurements were by individual quadrat.
- Species cover was measured in 4 (sometimes 6) quadrats at each station, labeled 1L (left and adjacent to transect tape when looking upstream), 2L (1-2 m left of transect tape), 1R (right and adjacent to transect tape), and 2R (1-2 m right of transect tape). Cover must be averaged (summarised) across quadrats for each station, and perennial richness and Shannon diversity must also be calculated by pooling all quadrats for each station.
- Sampling occurred once in March of 2012, but we will only use data from November surveys.
- Cover is further summarised by plant species (identified by common name), total plant cover, and herbaceous cover.
  - Grouping based on lifeform beyond just herbaceous is not pursued anymore. Ground cover data also not used in later analysis, so it has been removed. See previous version of annotation for that analysis.
- `Year` is formatted in two ways:
  - As only 4 digits, as character (`20XX`)
  - As the correct year but all assigned Jan, so as to align correctly on the x-axis (`20XX-01-01`)
- Ultimately this script will produce cleaned data for plant cover and diversity from 2012-2021.
- Annotations refer to the chunk of code above.


# Setup
```{r}
library(tidyverse)
library(vegan)

# Load data ---------------------------------------------------------------

all.c12 <- read.csv("data/cleaned/C12-cover.csv")
all.c13 <- read.csv("data/cleaned/C13-cover.csv")
all.c19 <- read.csv("data/cleaned/C19-cover.csv")
all.c21 <- read.csv("data/cleaned/C21-cover.csv")
```

# Summarise quadrats by station
```{r}
# Summarise by plant species ----------------------------------------------

# Remove ground cover data for all channels
plant.c13 <- all.c13 %>% 
  filter(!Common %in% c("Rock", "Gravel", "Soil", "Litter", "Biocrust")) %>% 
  group_by(Station, Year, Functional, Native, Common, Scientific) %>% 
  summarise(Cover = mean(Cover), .groups = "keep")

plant.c21 <- all.c21 %>% 
  filter(!Common %in% c("Rock", "Gravel", "Soil", "Litter", "Biocrust")) %>% 
  group_by(Station, Year, Functional, Native, Common, Scientific) %>% 
  summarise(Cover = mean(Cover), .groups = "keep")

plant.c19 <- all.c19 %>% 
  filter(!Common %in% c("Rock", "Gravel", "Soil", "Litter", "Biocrust")) %>% 
  group_by(Station, Year, Functional, Native, Common, Scientific) %>% 
  summarise(Cover = mean(Cover), .groups = "keep")

plant.c12 <- all.c12 %>% 
  filter(!Common %in% c("Rock", "Gravel", "Soil", "Litter", "Biocrust")) %>% 
  group_by(Station, Year, Functional, Native, Common, Scientific) %>% 
  summarise(Cover = mean(Cover), .groups = "keep")
```
- This averages the 4 (sometimes 6) quadrats of each plant species for all the channels.
- Each station now has a single cover value for each plant species.


# Combine and remove 0% cover
```{r}
# Combine channels and remove rows of 0% cover
plant.all <- rbind(plant.c12, plant.c13, plant.c19, plant.c21)
plant.all <- plant.all %>% 
  filter(Cover > 0) %>% 
  separate(Station, c("Channel", "Station"), "_")
```
- Because of how the data sheets were formatted, certain common species were pre-filled in, and converted to 0 when not found in quadrats. We do not consider these 0s to be data because we are not interested in tracking specific species across time, so it is okay to remove these.


# Add grouping variables
```{r}
# Add grouping cols
# Add station and channel treatment cols
plant.all <- plant.all |> 
  mutate(station.trt = case_when(
    str_detect(Station, "ORD") ~ "One rock dam",
    str_detect(Station, "BAF") ~ "Baffle",
    TRUE ~ "No treatment"))

# Add channel treatment
plant.all <- plant.all |> 
  mutate(channel.trt = case_when(
    str_detect(Channel, "12") ~ "Channel 12: No treatment",
    str_detect(Station, "13") ~ "Channel 13: In-channel treatment",
    str_detect(Station, "19") ~ "Channel 19: Upland treatment",
    TRUE ~ "Channel 21: In-channel treatment"))

# Add Treatment1
plant.all <- plant.all |> 
  mutate(Treatment1 = case_when(
    str_detect(Station, "19") ~ "Upland",
    TRUE ~ station.trt)) |> 
  mutate(Treatment1 = as.factor(Treatment1))

# Add Treatment2
plant.all$Treatment2 <- as.factor(gsub("^.*?: ", "", plant.all$channel.trt))

# Add Treatment3
plant.all <- plant.all |> 
  mutate(Treatment3 = case_when(
    str_detect("In-channel treatment", channel.trt) ~ "Treated",
    TRUE ~ "Control")) |> 
  mutate(Treatment3 = as.factor(Treatment3))

# Add woody/herbaceous
plant.all <- plant.all |> 
  mutate(woody = case_when(
    str_detect(Functional, c("grass|forb")) ~ "Herbaceous",
    TRUE ~ "Woody")) 

# Remove March 2012 sampling
plant.all <- plant.all |> 
  filter(Year != "2012-03-01")

# Add year.xaxis 
plant.all <-plant.all |> 
  mutate(year.xaxis = case_when(
    Year == "2012-11-01" ~ "2012-01-01",
    Year == "2013-11-01" ~ "2013-01-01",
    Year == "2014-11-01" ~ "2014-01-01",
    Year == "2015-11-01" ~ "2015-01-01",
    Year == "2018-11-01" ~ "2018-01-01",
    Year == "2021-11-01" ~ "2021-01-01")) |> 
  mutate(year.xaxis = as.Date(year.xaxis))

# Shorten Year to 4 digits
plant.all$Year <- as.factor(gsub("-.*", "", plant.all$Year))
```


# Summarise by total cover and herb cover
```{r}
total.all <- plant.all %>% 
  group_by(Channel, Station, Year, station.trt, channel.trt,
           Treatment1, Treatment2, Treatment3, year.xaxis) %>% 
  summarise(Cover = sum(Cover), .groups = "keep")

herb.all <- plant.all %>% 
  group_by(Channel, Station, Year, station.trt, channel.trt, woody,
           Treatment1, Treatment2, Treatment3, year.xaxis) %>% 
  summarise(Cover = sum(Cover), .groups = "keep") |> 
  filter(woody == "Herbaceous")
```
- More specific groups are made by summing the appropriate species by category.


# Calculate richness and Shannon
```{r}
# Richness and Shannon ----------------------------------------------------

# Remove annuals
plant.per <- plant.all |> 
  filter(!str_detect(Functional, "Annual"))

# By treatment and station
richness <- plant.per %>%  
  group_by(Channel, Station, Year, station.trt, channel.trt,
           Treatment1, Treatment2, Treatment3, year.xaxis) %>% 
  summarise(rich = n_distinct(Common),
            .groups = "keep") 

shannon <- plant.per %>%  
  group_by(Channel, Station, Year, station.trt, channel.trt,
           Treatment1, Treatment2, Treatment3, year.xaxis) %>% 
  summarise(shan = diversity(Cover),
            .groups = "keep")

per.div <- left_join(richness, shannon)
```

# Assign an ID for each sampling event
```{r}
# Assign record number for each sampling event ----------------------------

# Create ID
all.c <- bind_rows(all.c12, all.c13, all.c19, all.c21) %>% 
  select(Year, Station) %>% 
  distinct(.keep_all = TRUE) %>% 
  arrange(Year) |> 
  filter(Year != "2012-03-01") 
all.c$PlotTimeID <- c(1:nrow(all.c)) 
all.c <- all.c %>% 
  separate(Station, c("Channel", "Station"), "_") %>% 
  select(PlotTimeID, Year, Channel, Station)
all.c$Year <- gsub("-.*", "", all.c$Year)

# Add to ID dataframes (remove NAs because some data sheets were lost)
plant.all <- left_join(all.c, plant.all) %>% 
  filter(!is.na(Cover))
total.all <- left_join(all.c, total.all) %>% 
  filter(!is.na(Cover))
herb.all <- left_join(all.c, herb.all) %>% 
  filter(!is.na(Cover))
per.div <- left_join(all.c, per.div) |> 
  filter(!is.na(shan))
```
- "Each sampling event" refers to every station, with each year as a unique event.

# Save as CSVs and `.RData`
```{r}
# Save dataframes ---------------------------------------------------------

write_csv(plant.all,
          file = "data/cleaned/Summarised-all_plant-species-cover.csv")
write_csv(total.all,
          file = "data/cleaned/Summarised-all_total-plant-cover.csv")
write_csv(herb.all,
          file = "data/cleaned/Summarised-all_herb-cover.csv")
write_csv(per.div,
          file = "data/cleaned/Summarised-all_perennial-diversity.csv")


save.image("RData/Summarise-all-channels.RData")
```
